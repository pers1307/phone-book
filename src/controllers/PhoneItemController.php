<?php/** * PhoneItemController.php * * @author      Pereskokov Yurii * @copyright   2020 Pereskokov Yurii * @license     The MIT License (MIT) http://opensource.org/licenses/mit-license.php * @link        https://github.com/pers1307/phone-book */namespace pers1307\phoneBook\controllers;use pers1307\phoneBook\exception\FormNotValidException;use pers1307\phoneBook\exception\InvalidAutorizationException;use pers1307\phoneBook\exception\NoPostArgumentException;use pers1307\phoneBook\exception\NotFoundEntityException;use pers1307\phoneBook\forms\PhoneForm;use pers1307\phoneBook\repository\PhoneRepository;use pers1307\phoneBook\service\Autorization;use pers1307\phoneBook\service\ConvertFormToEntity;use pers1307\phoneBook\service\Redirect;use pers1307\phoneBook\service\Request;use pers1307\phoneBook\service\Response;class PhoneItemController extends AbstractController{    /**     * @param $id     * @return string     */    public function editAction($id)    {        try {            Autorization::getInstance()->checkAutorizationWithException();            $phone = (new PhoneRepository())->findById($id);            if (is_null($phone)) {                throw new NotFoundEntityException('Phone number with this id not found');            }            /** @var Request $request */            $request = (new Request)->createFromGlobals();            $phoneForm = new PhoneForm();            if (!is_null($request->getPost())) {                $phoneForm = $phoneForm->getDataFromRequest($request);                $phoneForm->validate();                $phone = (new ConvertFormToEntity())->phoneFormToPhoneEntity(                    $phoneForm,                    Autorization::getInstance()->getCurrentUserId()                );                $phone->setId($id);                (new PhoneRepository())->update($phone);                (new Redirect())->gotoUrl('/phone/' . $phone->getId());            } else {                $phoneForm->fromEntityPhone($phone);            }            $response = new Response(200);            $response->setContent(                $this->render('phone_item_form.php', ['phoneForm' => $phoneForm])            );            return $response;        } catch (NotFoundEntityException $exception) {            $response = new Response(Response::HTTP_NOT_FOUND);            $response->setContent(                $this->render('404_error.php', [])            );            return $response;        } catch (InvalidAutorizationException $exception) {            $response = new Response(401);            $response->setContent(                $this->render('autorize_error.php', [])            );            return $response;        } catch (FormNotValidException $exception) {            $response = new Response(200);            $response->setContent(                $this->render('phone_item_form.php', [                    'phoneForm' => $phoneForm,                    'errors'    => $phoneForm->getErrors(),                ])            );            return $response;        } catch (NoPostArgumentException $exception) {            $response = new Response(500);            $response->setContent(                $this->render('server_error.php', [])            );            return $response;        } catch (\Exception $exception) {            $response = new Response(500);            $response->setContent(                $this->render('server_error.php', [])            );            return $response;        }    }    public function createAction()    {        try {            Autorization::getInstance()->checkAutorizationWithException();            /** @var Request $request */            $request = (new Request)->createFromGlobals();            $phoneForm = new PhoneForm();            if (!is_null($request->getPost())) {                $phoneForm = $phoneForm->getDataFromRequest($request);                $phoneForm->validate();                $phone = (new ConvertFormToEntity())->phoneFormToPhoneEntity(                    $phoneForm,                    Autorization::getInstance()->getCurrentUserId()                );                $phone = (new PhoneRepository())->insert($phone);                (new Redirect())->gotoUrl('/phone/' . $phone->getId());            }            $response = new Response(200);            $response->setContent(                $this->render('phone_item_form.php', ['phoneForm' => $phoneForm])            );            return $response;        } catch (InvalidAutorizationException $exception) {            $response = new Response(401);            $response->setContent(                $this->render('autorize_error.php', [])            );            return $response;        } catch (FormNotValidException $exception) {            $response = new Response(200);            $response->setContent(                $this->render('phone_item_form.php', [                    'phoneForm' => $phoneForm,                    'errors'    => $phoneForm->getErrors(),                ])            );            return $response;        } catch (NoPostArgumentException $exception) {            $response = new Response(500);            $response->setContent(                $this->render('server_error.php', [])            );            return $response;        } catch (\Exception $exception) {            $response = new Response(500);            $response->setContent(                $this->render('server_error.php', [])            );            return $response;        }    }    /**     * @param $id     * @return string     */    public function viewAction($id)    {        try {            Autorization::getInstance()->checkAutorizationWithException();            $phone = (new PhoneRepository())->findById($id);            if (is_null($phone)) {                throw new NotFoundEntityException('Phone number with this id not found');            }            $response = new Response(200);            $response->setContent(                $this->render('phone_item_view.php', ['phone' => $phone])            );            return $response;        } catch (InvalidAutorizationException $exception) {            $response = new Response(401);            $response->setContent(                $this->render('autorize_error.php', [])            );            return $response;        } catch (NotFoundEntityException $exception) {            $response = new Response(Response::HTTP_NOT_FOUND);            $response->setContent(                $this->render('404_error.php', [])            );            return $response;        } catch (\Exception $exception) {            $response = new Response(500);            $response->setContent(                $this->render('server_error.php', [])            );            return $response;        }    }}